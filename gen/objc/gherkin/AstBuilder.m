//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/nbransby/Documents/gherkin-java/src/main/java/gherkin/AstBuilder.java
//

#include "J2ObjC_source.h"
#include "gherkin/AstBuilder.h"
#include "gherkin/AstNode.h"
#include "gherkin/GherkinDialect.h"
#include "gherkin/GherkinLineSpan.h"
#include "gherkin/Parser.h"
#include "gherkin/ParserException.h"
#include "gherkin/StringUtils.h"
#include "gherkin/Token.h"
#include "gherkin/ast/Background.h"
#include "gherkin/ast/Comment.h"
#include "gherkin/ast/DataTable.h"
#include "gherkin/ast/DocString.h"
#include "gherkin/ast/Examples.h"
#include "gherkin/ast/Feature.h"
#include "gherkin/ast/GherkinDocument.h"
#include "gherkin/ast/Location.h"
#include "gherkin/ast/Node.h"
#include "gherkin/ast/Scenario.h"
#include "gherkin/ast/ScenarioOutline.h"
#include "gherkin/ast/Step.h"
#include "gherkin/ast/TableCell.h"
#include "gherkin/ast/TableRow.h"
#include "gherkin/ast/Tag.h"
#include "java/lang/RuntimeException.h"
#include "java/lang/StringBuilder.h"
#include "java/util/ArrayDeque.h"
#include "java/util/ArrayList.h"
#include "java/util/Deque.h"
#include "java/util/List.h"

@interface GHKAstBuilder () {
 @public
  id<JavaUtilDeque> stack_;
  id<JavaUtilList> comments_;
}

@end

J2OBJC_FIELD_SETTER(GHKAstBuilder, stack_, id<JavaUtilDeque>)
J2OBJC_FIELD_SETTER(GHKAstBuilder, comments_, id<JavaUtilList>)

__attribute__((unused)) static GHKAstNode *GHKAstBuilder_currentNode(GHKAstBuilder *self);

__attribute__((unused)) static id GHKAstBuilder_getTransformedNodeWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node);

__attribute__((unused)) static id<JavaUtilList> GHKAstBuilder_getTableRowsWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node);

__attribute__((unused)) static void GHKAstBuilder_ensureCellCountWithJavaUtilList_(GHKAstBuilder *self, id<JavaUtilList> rows);

__attribute__((unused)) static id<JavaUtilList> GHKAstBuilder_getCellsWithGHKToken_(GHKAstBuilder *self, GHKToken *token);

__attribute__((unused)) static id<JavaUtilList> GHKAstBuilder_getStepsWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node);

__attribute__((unused)) static GHKALocation *GHKAstBuilder_getLocationWithGHKToken_withInt_(GHKAstBuilder *self, GHKToken *token, jint column);

__attribute__((unused)) static NSString *GHKAstBuilder_getDescriptionWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node);

__attribute__((unused)) static id<JavaUtilList> GHKAstBuilder_getTagsWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node);

@interface GHKAstBuilder_1 : NSObject < GHKStringUtils_ToString >

- (NSString *)toStringWithId:(GHKToken *)t;

@end

J2OBJC_EMPTY_STATIC_INIT(GHKAstBuilder_1)

__attribute__((unused)) static void GHKAstBuilder_1_init(GHKAstBuilder_1 *self);

__attribute__((unused)) static GHKAstBuilder_1 *new_GHKAstBuilder_1_init(void) NS_RETURNS_RETAINED;

__attribute__((unused)) static GHKAstBuilder_1 *create_GHKAstBuilder_1_init(void);

@implementation GHKAstBuilder

J2OBJC_IGNORE_DESIGNATED_BEGIN
- (instancetype __nonnull)init {
  GHKAstBuilder_init(self);
  return self;
}
J2OBJC_IGNORE_DESIGNATED_END

- (void)reset {
  JreStrongAssignAndConsume(&stack_, new_JavaUtilArrayDeque_init());
  [stack_ pushWithId:create_GHKAstNode_initWithGHKParser_RuleType_(JreLoadEnum(GHKParser_RuleType, None))];
  JreStrongAssignAndConsume(&comments_, new_JavaUtilArrayList_init());
}

- (void)buildWithGHKToken:(GHKToken *)token {
  GHKParser_RuleType *ruleType = GHKParser_RuleType_castWithGHKParser_TokenType_(((GHKToken *) nil_chk(token))->matchedType_);
  if (token->matchedType_ == JreLoadEnum(GHKParser_TokenType, Comment)) {
    [((id<JavaUtilList>) nil_chk(comments_)) addWithId:create_GHKAComment_initWithGHKALocation_withNSString_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, token, 0), token->matchedText_)];
  }
  else {
    [((GHKAstNode *) nil_chk(GHKAstBuilder_currentNode(self))) addWithGHKParser_RuleType:ruleType withId:token];
  }
}

- (void)startRuleWithGHKParser_RuleType:(GHKParser_RuleType *)ruleType {
  [((id<JavaUtilDeque>) nil_chk(stack_)) pushWithId:create_GHKAstNode_initWithGHKParser_RuleType_(ruleType)];
}

- (void)endRuleWithGHKParser_RuleType:(GHKParser_RuleType *)ruleType {
  GHKAstNode *node = [((id<JavaUtilDeque>) nil_chk(stack_)) pop];
  id transformedNode = GHKAstBuilder_getTransformedNodeWithGHKAstNode_(self, node);
  [((GHKAstNode *) nil_chk(GHKAstBuilder_currentNode(self))) addWithGHKParser_RuleType:((GHKAstNode *) nil_chk(node))->ruleType_ withId:transformedNode];
}

- (GHKAGherkinDocument *)getResult {
  return [((GHKAstNode *) nil_chk(GHKAstBuilder_currentNode(self))) getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, GherkinDocument) withId:nil];
}

- (void)dealloc {
  RELEASE_(stack_);
  RELEASE_(comments_);
  [super dealloc];
}

@end

void GHKAstBuilder_init(GHKAstBuilder *self) {
  NSObject_init(self);
  [self reset];
}

GHKAstBuilder *new_GHKAstBuilder_init() {
  J2OBJC_NEW_IMPL(GHKAstBuilder, init)
}

GHKAstBuilder *create_GHKAstBuilder_init() {
  J2OBJC_CREATE_IMPL(GHKAstBuilder, init)
}

GHKAstNode *GHKAstBuilder_currentNode(GHKAstBuilder *self) {
  return [((id<JavaUtilDeque>) nil_chk(self->stack_)) peek];
}

id GHKAstBuilder_getTransformedNodeWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node) {
  switch ([((GHKAstNode *) nil_chk(node))->ruleType_ ordinal]) {
    case GHKParser_RuleType_Enum_Step:
    {
      GHKToken *stepLine = [node getTokenWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, StepLine)];
      GHKANode *stepArg = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, DataTable) withId:nil];
      if (stepArg == nil) {
        stepArg = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, DocString) withId:nil];
      }
      return create_GHKAStep_initWithGHKALocation_withNSString_withNSString_withGHKANode_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, stepLine, 0), ((GHKToken *) nil_chk(stepLine))->matchedKeyword_, stepLine->matchedText_, stepArg);
    }
    case GHKParser_RuleType_Enum_DocString:
    {
      GHKToken *separatorToken = [((id<JavaUtilList>) nil_chk([node getTokensWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, DocStringSeparator)])) getWithInt:0];
      NSString *contentType = [((NSString *) nil_chk(((GHKToken *) nil_chk(separatorToken))->matchedText_)) java_length] > 0 ? separatorToken->matchedText_ : nil;
      id<JavaUtilList> lineTokens = [node getTokensWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, Other)];
      JavaLangStringBuilder *content = create_JavaLangStringBuilder_init();
      jboolean newLine = false;
      for (GHKToken * __strong lineToken in nil_chk(lineTokens)) {
        if (newLine) [content appendWithNSString:@"\n"];
        newLine = true;
        [content appendWithNSString:((GHKToken *) nil_chk(lineToken))->matchedText_];
      }
      return create_GHKADocString_initWithGHKALocation_withNSString_withNSString_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, separatorToken, 0), contentType, [content description]);
    }
    case GHKParser_RuleType_Enum_DataTable:
    {
      id<JavaUtilList> rows = GHKAstBuilder_getTableRowsWithGHKAstNode_(self, node);
      return create_GHKADataTable_initWithJavaUtilList_(rows);
    }
    case GHKParser_RuleType_Enum_Background:
    {
      GHKToken *backgroundLine = [node getTokenWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, BackgroundLine)];
      NSString *description_ = GHKAstBuilder_getDescriptionWithGHKAstNode_(self, node);
      id<JavaUtilList> steps = GHKAstBuilder_getStepsWithGHKAstNode_(self, node);
      return create_GHKABackground_initWithGHKALocation_withNSString_withNSString_withNSString_withJavaUtilList_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, backgroundLine, 0), ((GHKToken *) nil_chk(backgroundLine))->matchedKeyword_, backgroundLine->matchedText_, description_, steps);
    }
    case GHKParser_RuleType_Enum_Scenario_Definition:
    {
      id<JavaUtilList> tags = GHKAstBuilder_getTagsWithGHKAstNode_(self, node);
      GHKAstNode *scenarioNode = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Scenario) withId:nil];
      if (scenarioNode != nil) {
        GHKToken *scenarioLine = [scenarioNode getTokenWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, ScenarioLine)];
        NSString *description_ = GHKAstBuilder_getDescriptionWithGHKAstNode_(self, scenarioNode);
        id<JavaUtilList> steps = GHKAstBuilder_getStepsWithGHKAstNode_(self, scenarioNode);
        return create_GHKAScenario_initWithJavaUtilList_withGHKALocation_withNSString_withNSString_withNSString_withJavaUtilList_(tags, GHKAstBuilder_getLocationWithGHKToken_withInt_(self, scenarioLine, 0), ((GHKToken *) nil_chk(scenarioLine))->matchedKeyword_, scenarioLine->matchedText_, description_, steps);
      }
      else {
        GHKAstNode *scenarioOutlineNode = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, ScenarioOutline) withId:nil];
        if (scenarioOutlineNode == nil) {
          @throw create_JavaLangRuntimeException_initWithNSString_(@"Internal grammar error");
        }
        GHKToken *scenarioOutlineLine = [scenarioOutlineNode getTokenWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, ScenarioOutlineLine)];
        NSString *description_ = GHKAstBuilder_getDescriptionWithGHKAstNode_(self, scenarioOutlineNode);
        id<JavaUtilList> steps = GHKAstBuilder_getStepsWithGHKAstNode_(self, scenarioOutlineNode);
        id<JavaUtilList> examplesList = [scenarioOutlineNode getItemsWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Examples_Definition)];
        return create_GHKAScenarioOutline_initWithJavaUtilList_withGHKALocation_withNSString_withNSString_withNSString_withJavaUtilList_withJavaUtilList_(tags, GHKAstBuilder_getLocationWithGHKToken_withInt_(self, scenarioOutlineLine, 0), ((GHKToken *) nil_chk(scenarioOutlineLine))->matchedKeyword_, scenarioOutlineLine->matchedText_, description_, steps, examplesList);
      }
    }
    case GHKParser_RuleType_Enum_Examples_Definition:
    {
      id<JavaUtilList> tags = GHKAstBuilder_getTagsWithGHKAstNode_(self, node);
      GHKAstNode *examplesNode = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Examples) withId:nil];
      GHKToken *examplesLine = [((GHKAstNode *) nil_chk(examplesNode)) getTokenWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, ExamplesLine)];
      NSString *description_ = GHKAstBuilder_getDescriptionWithGHKAstNode_(self, examplesNode);
      id<JavaUtilList> rows = [examplesNode getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Examples_Table) withId:nil];
      GHKATableRow *tableHeader = rows != nil && ![rows isEmpty] ? [rows getWithInt:0] : nil;
      id<JavaUtilList> tableBody = rows != nil && ![rows isEmpty] ? [rows subListWithInt:1 withInt:[rows size]] : nil;
      return create_GHKAExamples_initWithGHKALocation_withJavaUtilList_withNSString_withNSString_withNSString_withGHKATableRow_withJavaUtilList_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, examplesLine, 0), tags, ((GHKToken *) nil_chk(examplesLine))->matchedKeyword_, examplesLine->matchedText_, description_, tableHeader, tableBody);
    }
    case GHKParser_RuleType_Enum_Examples_Table:
    {
      return GHKAstBuilder_getTableRowsWithGHKAstNode_(self, node);
    }
    case GHKParser_RuleType_Enum_Description:
    {
      id<JavaUtilList> lineTokens = [node getTokensWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, Other)];
      jint end = [((id<JavaUtilList>) nil_chk(lineTokens)) size];
      while (end > 0 && [((NSString *) nil_chk(((GHKToken *) nil_chk([lineTokens getWithInt:end - 1]))->matchedText_)) java_matches:@"\\s*"]) {
        end--;
      }
      lineTokens = [lineTokens subListWithInt:0 withInt:end];
      return GHKStringUtils_joinWithGHKStringUtils_ToString_withNSString_withJavaLangIterable_(create_GHKAstBuilder_1_init(), @"\n", lineTokens);
    }
    case GHKParser_RuleType_Enum_Feature:
    {
      GHKAstNode *header = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Feature_Header) withId:create_GHKAstNode_initWithGHKParser_RuleType_(JreLoadEnum(GHKParser_RuleType, Feature_Header))];
      if (header == nil) return nil;
      id<JavaUtilList> tags = GHKAstBuilder_getTagsWithGHKAstNode_(self, header);
      GHKToken *featureLine = [header getTokenWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, FeatureLine)];
      if (featureLine == nil) return nil;
      id<JavaUtilList> scenarioDefinitions = create_JavaUtilArrayList_init();
      GHKABackground *background = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Background) withId:nil];
      if (background != nil) [scenarioDefinitions addWithId:background];
      [scenarioDefinitions addAllWithJavaUtilCollection:[node getItemsWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Scenario_Definition)]];
      NSString *description_ = GHKAstBuilder_getDescriptionWithGHKAstNode_(self, header);
      if (featureLine->matchedGherkinDialect_ == nil) return nil;
      NSString *language = [featureLine->matchedGherkinDialect_ getLanguage];
      return create_GHKAFeature_initWithJavaUtilList_withGHKALocation_withNSString_withNSString_withNSString_withNSString_withJavaUtilList_(tags, GHKAstBuilder_getLocationWithGHKToken_withInt_(self, featureLine, 0), language, featureLine->matchedKeyword_, featureLine->matchedText_, description_, scenarioDefinitions);
    }
    case GHKParser_RuleType_Enum_GherkinDocument:
    {
      GHKAFeature *feature = [node getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Feature) withId:nil];
      return create_GHKAGherkinDocument_initWithGHKAFeature_withJavaUtilList_(feature, self->comments_);
    }
  }
  return node;
}

id<JavaUtilList> GHKAstBuilder_getTableRowsWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node) {
  id<JavaUtilList> rows = create_JavaUtilArrayList_init();
  for (GHKToken * __strong token in nil_chk([((GHKAstNode *) nil_chk(node)) getTokensWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, TableRow)])) {
    [rows addWithId:create_GHKATableRow_initWithGHKALocation_withJavaUtilList_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, token, 0), GHKAstBuilder_getCellsWithGHKToken_(self, token))];
  }
  GHKAstBuilder_ensureCellCountWithJavaUtilList_(self, rows);
  return rows;
}

void GHKAstBuilder_ensureCellCountWithJavaUtilList_(GHKAstBuilder *self, id<JavaUtilList> rows) {
  if ([((id<JavaUtilList>) nil_chk(rows)) isEmpty]) return;
  jint cellCount = [((id<JavaUtilList>) nil_chk([((GHKATableRow *) nil_chk([rows getWithInt:0])) getCells])) size];
  for (GHKATableRow * __strong row in rows) {
    if ([((id<JavaUtilList>) nil_chk([((GHKATableRow *) nil_chk(row)) getCells])) size] != cellCount) {
      @throw create_GHKParserException_AstBuilderException_initWithNSString_withGHKALocation_(@"inconsistent cell count within the table", [row getLocation]);
    }
  }
}

id<JavaUtilList> GHKAstBuilder_getCellsWithGHKToken_(GHKAstBuilder *self, GHKToken *token) {
  id<JavaUtilList> cells = create_JavaUtilArrayList_init();
  for (GHKGherkinLineSpan * __strong cellItem in nil_chk(((GHKToken *) nil_chk(token))->mathcedItems_)) {
    [cells addWithId:create_GHKATableCell_initWithGHKALocation_withNSString_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, token, ((GHKGherkinLineSpan *) nil_chk(cellItem))->column_), cellItem->text_)];
  }
  return cells;
}

id<JavaUtilList> GHKAstBuilder_getStepsWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node) {
  return [((GHKAstNode *) nil_chk(node)) getItemsWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Step)];
}

GHKALocation *GHKAstBuilder_getLocationWithGHKToken_withInt_(GHKAstBuilder *self, GHKToken *token, jint column) {
  return column == 0 ? ((GHKToken *) nil_chk(token))->location_ : create_GHKALocation_initWithInt_withInt_([((GHKALocation *) nil_chk(((GHKToken *) nil_chk(token))->location_)) getLine], column);
}

NSString *GHKAstBuilder_getDescriptionWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node) {
  return [((GHKAstNode *) nil_chk(node)) getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Description) withId:nil];
}

id<JavaUtilList> GHKAstBuilder_getTagsWithGHKAstNode_(GHKAstBuilder *self, GHKAstNode *node) {
  GHKAstNode *tagsNode = [((GHKAstNode *) nil_chk(node)) getSingleWithGHKParser_RuleType:JreLoadEnum(GHKParser_RuleType, Tags) withId:create_GHKAstNode_initWithGHKParser_RuleType_(JreLoadEnum(GHKParser_RuleType, None))];
  if (tagsNode == nil) return create_JavaUtilArrayList_init();
  id<JavaUtilList> tokens = [tagsNode getTokensWithGHKParser_TokenType:JreLoadEnum(GHKParser_TokenType, TagLine)];
  id<JavaUtilList> tags = create_JavaUtilArrayList_init();
  for (GHKToken * __strong token in nil_chk(tokens)) {
    for (GHKGherkinLineSpan * __strong tagItem in nil_chk(((GHKToken *) nil_chk(token))->mathcedItems_)) {
      [tags addWithId:create_GHKATag_initWithGHKALocation_withNSString_(GHKAstBuilder_getLocationWithGHKToken_withInt_(self, token, ((GHKGherkinLineSpan *) nil_chk(tagItem))->column_), tagItem->text_)];
    }
  }
  return tags;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(GHKAstBuilder)

@implementation GHKAstBuilder_1

- (NSString *)toStringWithId:(GHKToken *)t {
  return ((GHKToken *) nil_chk(t))->matchedText_;
}

@end

void GHKAstBuilder_1_init(GHKAstBuilder_1 *self) {
  NSObject_init(self);
}

GHKAstBuilder_1 *new_GHKAstBuilder_1_init() {
  J2OBJC_NEW_IMPL(GHKAstBuilder_1, init)
}

GHKAstBuilder_1 *create_GHKAstBuilder_1_init() {
  J2OBJC_CREATE_IMPL(GHKAstBuilder_1, init)
}
